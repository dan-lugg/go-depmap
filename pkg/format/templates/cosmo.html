<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go Dependency Graph - Cosmograph</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #1a1a1a;
            font-family: sans-serif;
        }

        #graph-container {
            width: 100%;
            height: 100%;
            display: block;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            pointer-events: none;
            font-size: 18px;
        }

        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.85);
            padding: 15px 20px;
            border-radius: 8px;
            color: #eeeeee;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            pointer-events: none;
        }

        #info h2 {
            margin: 0 0 10px 0;
            font-size: 18px;
            font-weight: 600;
            color: #00d488;
        }

        #info p {
            margin: 5px 0;
            font-size: 13px;
            color: #bbbbbb;
        }

        #info strong {
            color: #00d488;
        }
    </style>
</head>
<body>

<div id="loading">Loading Cosmograph Visualization...</div>
<div id="graph-container"></div>

<div id="info">
    <h2>Go Dependency Graph</h2>
    <p><strong>Nodes:</strong> <span id="nodeCount">0</span></p>
    <p><strong>Links:</strong> <span id="linkCount">0</span></p>
    <p style="font-size: 11px; margin-top: 10px;">ðŸ’¡ Scroll to zoom â€¢ Drag to pan â€¢ Click nodes for details</p>
</div>

<script type="module">
  // Import Cosmograph and the data preparation helper from esm.sh CDN
  import {Cosmograph, prepareCosmographData} from 'https://esm.sh/@cosmograph/cosmograph@2?bundle';

  // Embedded data - will be injected by Go template
  // @formatter:off
  const data = {{ .Data }};
  // @formatter:on

  console.log("Loaded data:", data);
  console.log("Sample node:", data.nodes[0]);
  console.log("Sample link:", data.links[0]);

  // --- Configuration & Initialization ---

  async function run() {
    const container = document.getElementById('graph-container');
    const loading = document.getElementById('loading');

    // Update info display
    document.getElementById("nodeCount").textContent = data.nodes.length;
    document.getElementById("linkCount").textContent = data.links.length;

    // Define how Cosmograph should read our data
    const dataConfig = {
      points: {
        pointIdBy: 'id',
        pointColorBy: 'group', // This separates the nodes visually by package
        pointSizeBy: 'size',
        pointClusterBy: 'group', // This groups nodes by type (e.g., package, module)
        pointLabelBy: 'label' // Label for each node
      },
      links: {
        linkSourceBy: 'source',
        linkTargetsBy: ['target'], // Note: Must be an array of strings
        linkWidthBy: 'linkType' // Use linkType to determine width
      }
    };

    try {
      console.log("Preparing data with Cosmograph...");

      // Prepare data (required for Cosmograph v2+)
      // This indexes the data for high-performance rendering
      const processed = await prepareCosmographData(
          dataConfig,
          data.nodes,
          data.links
      );

      console.log("Data prepared, initializing graph...");

      // Initialize the Graph
      const graph = new Cosmograph(container, {
        // Pass the processed data buffers
        points: processed.points,
        links: processed.links,

        // Spread the generated config (contains accessors for colors/sizes)
        ...processed.cosmographConfig,

        // Visual Customization
        backgroundColor: '#1a1a1a',
        pointSizeScale: 1.5,
        linkWidth: 0.5, // Fixed width for all links
        linkColor: '#555555', // Neutral gray for all links
        linkArrows: true,
        linkArrowsSizeScale: 0.5,

        // Simulation Physics (tuned for hub-and-spoke with packages, types, and functions)
        simulationGravity: 0.1, // Slightly increased to pull nodes toward center
        simulationRepulsion: 0.8, // Increased to push nodes apart more
        simulationFriction: 0.985,
        simulationDecay: 500, // Fast cooldown - nodes settle quickly
        simulationLinkSpring: 1.5, // Stronger springs for dependencies
        simulationLinkDistance: 20, // Distance between connected nodes

        // Interaction
        hoveredPointColor: '#ffffff',
        onClick: (index) => {
          if (index == null) return;
          const node = data.nodes[index];
          alert(`Node Details:\n\nName: ${node.label}\nType: ${node.type}\nPackage: ${node.group}\nID: ${node.id}`);
        },
      });

      loading.style.display = 'none';
      console.log("Cosmograph visualization initialized successfully");

    } catch (error) {
      console.error("Error initializing Cosmograph:", error);
      loading.textContent = "Error loading graph. Check console.";
    }
  }

  run();
</script>
</body>
</html>
